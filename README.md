# PDF ParaParaTrans 2
**英文のPDF** から **パラグラフを解析して段落を抽出** し、原文と訳文を左右で対比させながら翻訳できるツールです。

- google翻訳APIとdeepLAPIに対応しています。
- google翻訳v3のAPIが設定できる方は、翻訳辞書機能(Grossary)を使用した翻訳も利用できます(上級者向け)。<br>
- 複雑なレイアウトのPDFから抽出された文章は段落が前後しがちです。<br>1画面でPDFと抽出文を並べて表示すると選択した段落がPDF上でもハイライトされます。段落の並べ替えをショートカットキーで素早く整えることができます。
- ゲームのルールブックの翻訳を主目的として開発されているため、特定の単語を自分の対訳辞書で置換してから翻訳することができます。
- PDFと下記の5項目を並べて表示し、段落ごとに翻訳済みかどうかのステータスを登録できます。<br>原文と訳文を比較しながら推敲を進めるのに最適です。

    | No | 項目 | 概要 |
    | - | ------ | - |
    | 1 | HTML | 原文のStyleをタグで持つ文字列 |
    | 2 | 原文 | 英文テキスト |
    | 3 | 置換文 | 対訳辞書で置換したテキスト。 このテキストが翻訳APIの対象です。|
    | 4 | Auto | 置換文を翻訳APIで翻訳したテキスト |
    | 5 | 訳文 | 初期値はAutoと同じです。自動翻訳をかけても変更されない、翻訳を確定させるための列です |

- パラグラフごとに自動翻訳の対象とするかどうかと、翻訳の進捗状況を保存することができます。
    | ステータス | 自動翻訳 | 概要 |
    | ------ | - | - |
    | 未翻訳 | 対象 | 自動翻訳されていない初期状態です |
    | 自動翻訳 | 対象 | 自動翻訳後に未翻訳から自動翻訳に変わります |
    | 下訳 | 対象外 | 推敲中のパラグラフに使用します。|
    | 確定 | 対象外 | 翻訳を確定したパラグラフに使用します。 |

## セットアップ 🛠

### GitHub Codespaces（インストール不要）

> **注意**
> - GitHub Codespaces の利用には、GitHub側で **支払い情報（クレジットカード等）の登録が必要** な場合があります。
> - 個人アカウントには無償枠（毎月）があり、目安は以下です（GitHub公式ドキュメントより）。
>   - GitHub Free（個人）: **15 GB/月**（ストレージ） + **120 時間**（コンピューティング）
>   - GitHub Pro: **20 GB/月**（ストレージ） + **180 時間**（コンピューティング）
>   - ※選ぶマシンスペック（CPUコア数）によって、同じ「1時間」でも消費のされ方が変わります。
> - 使い方が掴めたら、コストと速度の面で **ローカル環境での運用をおすすめ** します。

1. GitHubのリポジトリ画面で **Code** → **Codespaces** → **Create codespace** を選択
2. Codespaces のターミナルで依存関係をインストール:
    ```
    pip install -r requirements.txt
    ```
3. `.env_sample` を `.env` としてコピーし、内容を整える:
    ```
    cp .env_sample .env
    ```
    - `.env` を開いて **KEY情報を登録**（または Codespaces の Secrets に `TRANSLATOR` / `GOOGLE_API_KEY` / `DEEPL_AUTH_KEY` を登録）
4. `data` フォルダを作成し、変換したいPDFを入れる（エクスプローラーにドラッグ＆ドロップでOK）
5. ターミナルで起動する:
    ```
    python pdf-paraparatrans.py
    ```
6. 起動ログに出る `http://localhost:5077/` を `Ctrl + Click` で開く

### ローカル環境（zipダウンロード）

1. **[Source code(zip)](https://github.com/runequest77/pdf-paraparatrans2/releases) をダウンロード**
2. フォルダに解凍し、エクスプローラーでフォルダを選択してShiftを押しながら右クリック→[ターミナルで開く]
3. 必要なパッケージをインストール:
    ```
    pip install -r requirements.txt
    ```
    - エラー(赤文字で英文が表示された)が発生した場合、Pythonの実行環境をインストールする必要があります。  
      Windows11の場合、開いているターミナルで `python` と入力してエンターを押すと Microsoft Storeが開きます。  
      「入手」を押すと自動でダウンロード・インストールが行われます。  
      インストール後、ターミナルを閉じて `2.` から再度行ってください。
4. `.env_sample` を `.env` としてコピーし、内容を整える。
        - PowerShell:
            ```
            Copy-Item .env_sample .env
            ```
        - macOS / Linux:
            ```
            cp .env_sample .env
            ```
        - `.env` を開いて、googleかdeeplの利用しない方のコメントを外し、**KEY情報を登録**。<br>※後日詳しい記事を書きます。
5. 直下にdataフォルダを作成し、変換したいPDFを入れる。
6. ターミナルで起動する。
        ```
        python pdf-paraparatrans.py
        ```
7. 起動ログに出る `http://localhost:5077/` を `Ctrl + Click` で開く（dataフォルダ内に居れたpdfの一覧が表示されます）。<br>
⇒「使い方」セクションへ！
  > ### **MacOS** の場合
  > 1. ターミナルのコマンドがpython3系を明示する必要があります。
  > - pip → pip3
  > - python → python3

## 使い方
### 翻訳APIの準備
 [Google 翻訳 API（APIキー方式）のセットアップ / `GOOGLE_API_KEY` の取得](SETUP_GOOGLE_TRANSLATE.md)

 [Google 翻訳 API v3（上級者向け / Glossary(Grossary)）のセットアップ](SETUP_GOOGLE_TRANSLATE_V3.md)

 [DeepL API のセットアップ / `DEEPL_AUTH_KEY` の取得](SETUP_DEEPL.md)

正直ここが一番詰まると思います。<br>
わかりやすく書くのが🤚無理🤣なので、`Chat-GPT` とか `Gemini` とかを頼りに頑張ってください。

### 🔠 置換辞書の準備
`data\dict.txt` に翻訳前に置換したい単語を登録します。タブ区切りテキストファイルです。<br>
※ 以前は英日の置換でしたが、AI翻訳系の挙動が日本語の単語も再翻訳してしまうため、日本語への置換は非推奨としました。ゲームタームなどを括るための一括置換などの用途に使用できるため残してあります。

起動時に存在しない場合、サンプルが作成されます。

```
#置換前	#置換後	#状態	#出現回数
Blaadesharp|<<Bladesharp>>|0|3
Beffadle|<<Beffadle>>|0|2
```
> 3列目がステータスです。
> 0の場合、大文字小文字を区別せずに置換します。3列目のない辞書データは0として扱われます。
> 1の場合、大文字小文字が一致する場合のみ置換します。
> ステータスは2以上の行は対訳辞書の自動生成で使用します。ユーザーがステータスを0か1にするまで無視されます。
> 
> 4列目が抽出をかけた文書での単語の登場回数です。これは文書を切り替えて抽出を行うたびに再計算されます。


### 🅿️ PDF一覧画面
`data`フォルダにいれたPDFが一覧表示されます。PDF名をクリックすると、そのPDF用の画面に移動します。
### 📖 メイン画面

| No | 機能 | 概要 |
| - | - | - |
| 1 | パラグラフ抽出 | PDFを`data`フォルダに居れた後、**最初に `1.パラグラフ抽出` をクリック**します。<br>OKを押すと、少し待ち時間があった後にパラグラフが表示されます。 |
| - | (辞書抽出) | 現在の文書から固有名詞と解釈しうる文字列を置換辞書 `data/dict.csv` に「ステータス9（未翻訳）」で追加します。<br>すでに置換辞書にある文字列やステータスは維持されます。 |
| - | (辞書翻訳) | 対訳辞書 `data/dict.csv` のステータス9(未翻訳)のレコードを自動翻訳します。<br>カタカナになった単語はステータス6、翻訳後が翻訳前と変わらない単語はステータス7、それ以外はステータス8になります。<br>対訳辞書として有効にするにはステータスを0(大文字小文字を区別せず置換)か1(大文字小文字まで一致したときのみ置換)に変更してください。 |
| 2 | 全対訳置換 | 対訳辞書 `data/dict.csv` に従って原文を置換した結果を`置換文`列にセットします。 |
| - | (自動タグ付け) | ページヘッダ/フッタ/見出しを判定し、block_tagを変更します。 <br>見出しがセットされることで `目次パネル` が動作するようになります。|
| 3 | 全翻訳 | 文書の全ページに対して自動翻訳を実行します。 |
| 4 | ---- | (未実装) |
| 5 | 対訳ファイル出力 | dataフォルダに **`訳文`** と **`原文`** が横並びになったhtmlファイルを出力します。 <br>header/footerは翻訳/対訳htmlへの出力から除外されます。|
| - | 目次 | (未実装) <br>h1～h6に指定されたパラグラフを階層表示します。クリックで当該パラグラフに移動します。<br>チェックボックスで表示/非表示を切り替えられます。 |
| - | PDF | PDFの現在のページを表示します。<br>チェックボックスで表示/非表示を切り替えられます。 |
| - | ページ翻訳 | 現在のページに対して自動翻訳を実行します。|
| - | 高速編集 | ※まだ動作しません。|
| - | 順序保存 | パラグラフをドラッグ＆ドロップで並び替えることができます。そのページの並び替えた順序を保存します。 |
#### パラグラフ
- パラグラフは左端をつかんでドラッグすることで順序が入れ替えられます。
1. 右上のボタン [...] をクリックすると `✍️ 編集画面` が開きます。
2. [自動翻訳]をクリックすると、そのパラグラフだけを翻訳できます。
3. [種別]をh1～h6に変更すると、対訳ファイルのパラグラフがそのタグで囲まれます。
4. **[原文]** もしくは **[訳文]** の項目を編集できます。<br>[保存] で内容が保存され、編集画面が閉じます。
5. ステータス
    - `未翻訳` のパラグラフが「全翻訳」「ページ翻訳」の対象になります。
    - `自動翻訳` のパラグラフは 対訳辞書の変更によって置換文が変わる場合、「全対訳置換」を行うと`未翻訳`に戻ります。
    - `下訳`、`確定` のパラグラフは「全対訳置換」で置換文は変更されますが、ステータスは変わりません。

### ショートカットキー**
※高速編集モードはまだ動作しません(2025/03/30)。近日公開予定です。
#### **✅ 高速編集モード**
| **キー** | **動作** |
|----------|---------|
| **Ctrl + Q** | 高速編集モードON/OFF |
| **上下矢印** | カレントパラグラフの移動 |
| **Ctrl + ← / →** | ページ送り |
| **Ctrl + 1-6** | カレントパラグラフの見出しLVを h1-h6 にセット |
| **Ctrl + 0** | カレントパラグラフのタグを `p` にセット |
| **Shift + 上矢印** | 選択パラグラフ範囲を上に拡大 |
| **Shift + 下矢印** | 選択パラグラフ範囲を下に拡大 |
| **Ctrl + 上矢印** | 選択パラグラフを上に移動 |
| **Ctrl + 下矢印** | 選択パラグラフを下に移動 |
| **Ctrl + Shift + 上矢印** | 選択パラグラフを最上へ移動 |
| **Ctrl + Shift + 下矢印** | 選択パラグラフを最下へ移動 |
| **Esc** | 選択解除＆カレント行にフォーカス |
| **Ctrl + S** | 編集状態を保存 |

#### **✅ 通常モード**
| **キー** | **動作** |
|----------|---------|
| **上下矢印** | 画面スクロール（ブラウザデフォルト） |
| **Ctrl + ← / →** | ページ送り |

## パラグラフ自動解析について
パラグラフがどれぐらいきれいにまとまるかは、PDFの作りによります。<br>
同一パラグラフが改行されるときに後ろにスペースがつくタイプのPDFはかなり綺麗にまとまっています。<br>
つくりの悪いPDFに対する対処も検討していますが、いまのところ悪影響の方が多いので実装していません。<br>
要望が多いようであればもう少し他の機能を煮詰めてから検討してみます。

## 今後の予定とか
下記のようなことを思いついていますが、みなさんの要望やアイデアがあれば対応できるものからやっていきますので、気軽にお声がけ下さい。<br>
プルリクも歓迎します。
### 機能
- 目次パネル
- **DeepL API** 対応
- ~~ページヘッダ/フッダの自動検出＆翻訳/html出力対象外~~ (2025/03/16)
- キーボードショートカットによる高速な並び替え、block_Tagの変更
- 著作権に配慮した`文書の構造情報`だけをエクスポート/インポートできる機能
### 文書
- 使い方のコツの説明動画作成
- 技術解説記事
### 辞書置換
- ~~**大文字開始の固有名詞の自動抽出**と**下訳をした辞書ファイル**の生成~~ (2025/03/16)
- ~~大文字小文字の区別有無を指定できる辞書ファイル形式~~ (2025/03/16)
- 新規抽出単語を既存の辞書で置換し、翻訳対象を絞り込む機能。単語としての抽出範囲の精度向上。
- **ルーンフォント**など特殊フォントを指定できる辞書ファイル形式
- ~~文書ごとの辞書ファイル登録~~ あまり効果的でないと判断したので強い要望がなければ実装しません。
### パラグラフ処理
- ページをまたぐパラグラフの結合
- 自動翻訳に送らないパターンの精査と送信前の予測文字数/削減文字数の通知
- 文書内で同一内容のパラグラフは1パラグラフだけ自動翻訳
### 書式
- ライトモード
- 文書解析時などの待ち時間をユーザーに通知
- ~~原文のStyleを適用したhtml表示~~(2025/03/30)
- PDFを1ページ表示ではなく複数ページ表示
- trを指定したパラグラフをテーブル化してhtml出力
- PDFのメタデータに目次が登録されている場合、対応パラグラフにh1-h6をセット
### バグ
- ~~原文にタグと見なせる文字列が含まれていた場合自動翻訳が失敗する~~ (2025/03/30修正)
- パラグラフの末尾が-のときにまだ1パラグラフとして結合されないケースがある
- パラグラフの判定が甘いときに、自動翻訳が勝手に1パラグラフとしてまとめるため、前のパラグラフに訳が流れ込み、後ろのパラグラフが未翻訳状態になる
- 高速編集モードはまだ動作しません

## 更新履歴（★は破壊的なバージョン変更）
- v0.6.0: 2025/03/30 目次パネル実装。テキスト中にタグと解釈しうるエラーが含まれていた場合エラーになっていたバグを修正。<br>編集していて目がつらかったのでいったんダークモード。あとでライトモードも実装します。
- v0.5.2: 2025/03/19 port5000がmacで競合するようなので既定のportを5077に変更。
- v0.5.0: 2025/03/18 ★DeepLとの切り替えに対応。google認証をAPIキー方式に切り替えています。すでに利用中の方は申し訳ないですがAPIキーの取得と設定をお願いします。
- v0.4.2: 2025/03/16 対訳辞書の自動生成と自動翻訳、大文字小文字の区別を可能に。<br>ヘッダ/フッタの自動判定追加。
- v0.4.0: 2025/03/16 ★paragraphにfirst_line_bboxを追加。それ以前のバージョンで作成したjsonは「ヘッダ/フッダの自動判定」が動作しません。

## 🙏 寄付のお願い
**PDF ParaParaTrans** はフリーウェアですが、翻訳APIを使用したテストを繰り返すため、50万字の無料枠を超過して困っています。

なるべく自分に必要な文書をテストを兼ねて実行するようにはしていますが、ロジックの改善は一定量以上の同じ文書を繰り返し送る必要があるので、すぐに5万字、10万字とカウントが上がってしまいます。

よろしければ **runequest77@gmail.com** 宛てに **[amazonギフト券](https://www.amazon.co.jp/b?node=2351652051)** をお送りいただけますと、費用の不安が減って私の心が安らぎます。

## 連絡先
[X(twitter) @nayuta77](https://x.com/nayuta77)




