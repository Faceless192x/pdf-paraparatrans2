<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>PDF ParaParaTrans - 初期画面</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='paraparatrans.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/help-tooltip.css') }}">
</head>
<body>
    <div class="app-header">
        <div class="app-title">
            <img src="{{ url_for('static', filename='paraparatrans.svg') }}" alt="Icon" class="app-icon">
            <h1>PDF ParaParaTrans</h1>
        </div>
        <div class="header-actions">
            <button onclick="refreshBookList()" data-help-id="ブックリストの更新">一覧を更新</button>
            <input id="pdf-upload-input" type="file" accept="application/pdf,.pdf" style="display:none">
            <button type="button" id="pdf-upload-button" class="pdf-upload-button" data-help-id="PDFのアップロード">PDFを追加</button>
          <button type="button" id="url-book-button" data-help-id="URLブックの追加">URLを追加</button>
            <button id="show-full-help">Help</button>
        </div>
    </div>
    <div id="pdf-upload-status" class="upload-status"></div>
    <div id="pdf-move-status" class="upload-status"></div>
    <div id="pdf-move-dialog" class="move-dialog" style="display:none">
      <div class="move-dialog-content">
        <div class="move-dialog-title">移動先フォルダを選択</div>
        <select id="pdf-move-target">
          <option value="">/ (ルート)</option>
          {% for dir in all_dirs %}
            <option value="{{ dir }}">{{ dir }}</option>
          {% endfor %}
        </select>
        <div class="move-dialog-actions">
          <button type="button" onclick="confirmMove()">移動</button>
          <button type="button" onclick="closeMoveDialog()">キャンセル</button>
        </div>
      </div>
    </div>
    <form method="GET">
      {% if current_dir %}
        <input type="hidden" name="dir" value="{{ current_dir|e }}">
      {% endif %}
      <input type="text" name="filter" placeholder="タイトル/ファイル名でフィルタ" value="{{ filter_text|e }}">
      <button type="submit" data-help-id="ブックのフィルタリング">フィルタ</button>
    </form>
    <div class="folder-nav">
        <div class="folder-breadcrumbs">
          {% for crumb in breadcrumbs %}
            {% if loop.last %}
              <span>{{ crumb.name }}</span>
            {% else %}
              <a href="{{ url_for('index', dir=crumb.path) }}">{{ crumb.name }}</a> /
            {% endif %}
          {% endfor %}
        </div>
        <div class="folder-actions">
          <button type="button" onclick="createFolder()">フォルダ作成</button>
          {% if current_dir %}
            <button type="button" onclick="renameFolder('{{ current_dir|e }}')">現在のフォルダ名変更</button>
            <button type="button" onclick="deleteFolder('{{ current_dir|e }}')">現在のフォルダ削除</button>
          {% endif %}
        </div>
        {% if current_dir and parent_dir is not none %}
          <div class="folder-up">
            <a href="{{ url_for('index', dir=parent_dir) }}">.. (上のフォルダ)</a>
          </div>
        {% endif %}
        <div class="folder-list">
          <div class="folder-list-title">フォルダ</div>
          {% if subdirs %}
            <ul class="folder-list-items">
              {% for folder in subdirs %}
                <li>
                  <a href="{{ url_for('index', dir=folder.rel_path) }}">{{ folder.name }}</a>
                  <button type="button" class="folder-action" onclick="renameFolder('{{ folder.rel_path|e }}')">名前変更</button>
                  <button type="button" class="folder-action" onclick="deleteFolder('{{ folder.rel_path|e }}')">削除</button>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="folder-list-empty">フォルダはありません</div>
          {% endif %}
        </div>
        <div id="folder-action-status" class="folder-status"></div>
    </div>
    <table class="book-list">
        <thead>
            <tr><th>Id</th><th>タイトル</th><th>ファイル名</th><th>none</th><th>auto</th><th>draft</th><th>fixed</th><th>更新日</th><th>操作</th></tr>
        </thead>
        <tbody>
        {% for idx, (pdf_name, item) in enumerate(pdf_dict.items()) %}
            <tr>
              <td>{{ idx+1 }}</td>
              <td>
                {{ item['title'] }}
                {% if item.get('book_type') == 'url' %}
                  <span class="book-type-tag">URL</span>
                {% endif %}
              </td>
              <td><a href="{{ url_for('detail', pdf_name=pdf_name) }}">{{ pdf_name }}</a></td>
              <td>{{ item.get('trans_status_counts', {}).get('none', 0) }}</td>
              <td>{{ item.get('trans_status_counts', {}).get('auto', 0) }}</td>
              <td>{{ item.get('trans_status_counts', {}).get('draft', 0) }}</td>
              <td>{{ item.get('trans_status_counts', {}).get('fixed', 0) }}</td>
              <td>{{ item['updated'] }}</td>
              <td>
                {% if item.get('book_type') == 'url' %}
                  <span class="book-action-placeholder">-</span>
                {% else %}
                  <button type="button" onclick='openMoveDialog({{ pdf_name|tojson }})'>移動</button>
                {% endif %}
              </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <script>
        async function refreshBookList() {
            const url = window.location.pathname + window.location.search;
            fetch(url, { method: "POST" })
            .then(response => {
              if (response.ok) {
                window.location.reload(); // ページをリロードして更新内容を反映
              } else {
                console.error("リストリフレッシュに失敗しました");
              }
            });    
        }

      const uploadInput = document.getElementById('pdf-upload-input');
      const uploadButton = document.getElementById('pdf-upload-button');
      const urlBookButton = document.getElementById('url-book-button');
      const statusEl = document.getElementById('pdf-upload-status');
      const moveStatusEl = document.getElementById('pdf-move-status');
      const moveDialogEl = document.getElementById('pdf-move-dialog');
      const moveTargetEl = document.getElementById('pdf-move-target');
      const uploadButtonLabel = uploadButton.textContent;
      const currentDir = "{{ current_dir|e }}";
      let pendingMovePdfName = '';

      function setUploadStatus(message, isError = true) {
        if (!message) {
          statusEl.style.display = 'none';
          statusEl.textContent = '';
          return;
        }
        statusEl.style.display = 'block';
        statusEl.style.color = isError ? '#b00020' : '#0a7a0a';
        statusEl.textContent = message;
      }

      function setMoveStatus(message, isError = true) {
        if (!message) {
          moveStatusEl.style.display = 'none';
          moveStatusEl.textContent = '';
          return;
        }
        moveStatusEl.style.display = 'block';
        moveStatusEl.style.color = isError ? '#b00020' : '#0a7a0a';
        moveStatusEl.textContent = message;
      }

      async function uploadSelectedFile() {
        if (!uploadInput.files || uploadInput.files.length !== 1) {
          return;
        }
        const file = uploadInput.files[0];
        const form = new FormData();
        form.append('file', file);
        // PDFの更新日時を引き継ぐ（ローカルファイルのmtime）
        form.append('last_modified_ms', String(file.lastModified || ''));

        uploadButton.disabled = true;
        uploadButton.classList.add('is-busy');
        uploadButton.textContent = 'アップロード中…';
        setUploadStatus(`アップロード中…\n${file.name}`, false);

        try {
          const res = await fetch('/api/upload_pdf', { method: 'POST', body: form });
          const data = await res.json().catch(() => ({}));

          if (res.status === 201 || res.ok) {
            setUploadStatus('アップロード完了。一覧を更新しています…', false);
            window.location.reload();
            return;
          }

          if (res.status === 409) {
            setUploadStatus((data.message ? `${data.message}\n` : '') + 'ファイル名（同名）を変えて再試行してください。');
          } else {
            setUploadStatus(data.message || `アップロードに失敗しました (${res.status})`);
          }
        } catch (e) {
          setUploadStatus(`アップロードに失敗しました: ${e}`);
        } finally {
          uploadButton.disabled = false;
          uploadButton.classList.remove('is-busy');
          uploadButton.textContent = uploadButtonLabel;
          // 同じファイルを選び直しても change が発火するようにクリア
          uploadInput.value = '';
        }
      }

      uploadButton.addEventListener('click', () => {
        setUploadStatus('');
        // 同じファイルを再選択できるようにする
        uploadInput.value = '';
        uploadInput.click();
      });

      uploadInput.addEventListener('change', async () => {
        setUploadStatus('');
        if (!uploadInput.files || uploadInput.files.length !== 1) {
          return;
        }
        await uploadSelectedFile();
      });

      function openMoveDialog(pdfName) {
        pendingMovePdfName = pdfName;
        setMoveStatus('');
        if (moveTargetEl) {
          moveTargetEl.value = currentDir || '';
        }
        if (moveDialogEl) {
          moveDialogEl.style.display = 'flex';
        }
      }

      function encodePathSegment(path) {
        return encodeURIComponent(path).replace(/%2F/g, '/');
      }

      async function createUrlBook() {
        setUploadStatus('');
        const url = window.prompt('翻訳対象のURLを入力してください');
        if (!url) {
          return;
        }

        urlBookButton.disabled = true;
        urlBookButton.classList.add('is-busy');
        setUploadStatus(`URLブックを作成中...\n${url}`, false);

        try {
          const res = await fetch('/api/url_book/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url }),
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok || data.status !== 'ok') {
            setUploadStatus(data.message || `URLブック作成に失敗しました (${res.status})`);
            return;
          }

          const bookName = data.book_name;
          if (bookName) {
            window.location.href = `/detail/${encodePathSegment(bookName)}`;
            return;
          }

          setUploadStatus('URLブック作成に成功しました。', false);
          window.location.reload();
        } catch (e) {
          setUploadStatus(`URLブック作成に失敗しました: ${e}`);
        } finally {
          urlBookButton.disabled = false;
          urlBookButton.classList.remove('is-busy');
        }
      }

      if (urlBookButton) {
        urlBookButton.addEventListener('click', createUrlBook);
      }

      function closeMoveDialog() {
        if (moveDialogEl) {
          moveDialogEl.style.display = 'none';
        }
      }

      async function confirmMove() {
        if (!pendingMovePdfName) {
          closeMoveDialog();
          return;
        }
        const dest = moveTargetEl ? moveTargetEl.value : '';
        try {
          const res = await fetch('/api/pdf/move', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pdf_name: pendingMovePdfName, dest_dir: (dest || '').trim() })
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            setMoveStatus(data.message || `移動に失敗しました (${res.status})`);
            return;
          }
          setMoveStatus('移動しました。一覧を更新しています…', false);
          window.location.reload();
        } catch (e) {
          setMoveStatus(`移動に失敗しました: ${e}`);
        } finally {
          closeMoveDialog();
          pendingMovePdfName = '';
        }
      }
      const folderStatusEl = document.getElementById('folder-action-status');

      function setFolderStatus(message, isError = true) {
        if (!message) {
          folderStatusEl.style.display = 'none';
          folderStatusEl.textContent = '';
          return;
        }
        folderStatusEl.style.display = 'block';
        folderStatusEl.style.color = isError ? '#b00020' : '#0a7a0a';
        folderStatusEl.textContent = message;
      }

      async function createFolder() {
        setFolderStatus('');
        const name = prompt('作成するフォルダ名を入力してください');
        if (name === null) return;
        const res = await fetch('/api/folder/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dir: currentDir, name: name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setFolderStatus(data.message || `フォルダ作成に失敗しました (${res.status})`);
          return;
        }
        setFolderStatus('フォルダを作成しました', false);
        window.location.href = `/?dir=${encodeURIComponent(data.path || currentDir || '')}`;
      }

      async function renameFolder(dirPath) {
        setFolderStatus('');
        const name = prompt('新しいフォルダ名を入力してください');
        if (name === null) return;
        const res = await fetch('/api/folder/rename', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dir: dirPath, new_name: name })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setFolderStatus(data.message || `フォルダ名変更に失敗しました (${res.status})`);
          return;
        }
        const targetDir = data.path || '';
        if (dirPath === currentDir) {
          window.location.href = targetDir ? `/?dir=${encodeURIComponent(targetDir)}` : '/';
          return;
        }
        window.location.reload();
      }

      async function deleteFolder(dirPath) {
        setFolderStatus('');
        if (!confirm('空のフォルダのみ削除できます。削除しますか？')) {
          return;
        }
        const res = await fetch('/api/folder/delete', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ dir: dirPath })
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          setFolderStatus(data.message || `フォルダ削除に失敗しました (${res.status})`);
          return;
        }
        if (dirPath === currentDir) {
          const nextDir = data.parent_dir || '';
          window.location.href = nextDir ? `/?dir=${encodeURIComponent(nextDir)}` : '/';
          return;
        }
        window.location.reload();
      }
    </script>
    <style>
      .move-dialog {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
      }
      .move-dialog-content {
        background: #ffffff;
        border: 1px solid #ccc;
        color: #111111;
        padding: 16px;
        min-width: 280px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      }
      .move-dialog-title {
        margin-bottom: 8px;
        font-weight: 600;
      }
      .move-dialog-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
      }
      @media (prefers-color-scheme: dark) {
        .move-dialog {
          background: rgba(0, 0, 0, 0.5);
        }
        .move-dialog-content {
          background: #1f1f1f;
          border-color: #444444;
          color: #f0f0f0;
          box-shadow: 0 2px 10px rgba(0, 0, 0, 0.6);
        }
      }
    </style>
    <script src="{{ url_for('static', filename='js/help.js') }}"></script>
</body>
</html>
