<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>PDF ParaParaTrans - 初期画面</title>
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='paraparatrans.svg') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/help-tooltip.css') }}">
</head>
<body>
    <div class="app-header">
        <img src="{{ url_for('static', filename='paraparatrans.svg') }}" alt="Icon" class="app-icon">
        <h1>PDF ParaParaTrans</h1>
        <button onclick="refreshBookList()" data-help-id="ブックリストの更新">一覧を更新</button>
        <input id="pdf-upload-input" type="file" accept="application/pdf,.pdf" style="display:none">
        <button type="button" id="pdf-upload-button" class="pdf-upload-button" data-help-id="PDFのアップロード">PDFを追加</button>
        <button id="show-full-help">Help</button>
    </div>
    <div id="pdf-upload-status" class="upload-status"></div>
    <form method="GET">
      <input type="text" name="filter" placeholder="タイトル/ファイル名でフィルタ" value="{{ filter_text|e }}">
      <button type="submit" data-help-id="ブックのフィルタリング">フィルタ</button>
    </form>
    <table class="book-list">
        <thead>
            <tr><th>Id</th><th>タイトル</th><th>ファイル名</th><th>none</th><th>auto</th><th>draft</th><th>fixed</th><th>更新日</th></tr>
        </thead>
        <tbody>
        {% for idx, (pdf_name, item) in enumerate(pdf_dict.items()) %}
            <tr>
              <td>{{ idx+1 }}</td>
              <td>{{ item['title'] }}</td>
              <td><a href="{{ url_for('detail', pdf_name=pdf_name) }}">{{ pdf_name }}</a></td>
              <td>{{ item.get('trans_status_counts', {}).get('none', 0) }}</td>
              <td>{{ item.get('trans_status_counts', {}).get('auto', 0) }}</td>
              <td>{{ item.get('trans_status_counts', {}).get('draft', 0) }}</td>
              <td>{{ item.get('trans_status_counts', {}).get('fixed', 0) }}</td>
              <td>{{ item['updated'] }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
    <script>
        async function refreshBookList() {
            fetch("/", { method: "POST" })
            .then(response => {
              if (response.ok) {
                window.location.reload(); // ページをリロードして更新内容を反映
              } else {
                console.error("リストリフレッシュに失敗しました");
              }
            });    
        }

      const uploadInput = document.getElementById('pdf-upload-input');
      const uploadButton = document.getElementById('pdf-upload-button');
      const statusEl = document.getElementById('pdf-upload-status');
      const uploadButtonLabel = uploadButton.textContent;

      function setUploadStatus(message, isError = true) {
        if (!message) {
          statusEl.style.display = 'none';
          statusEl.textContent = '';
          return;
        }
        statusEl.style.display = 'block';
        statusEl.style.color = isError ? '#b00020' : '#0a7a0a';
        statusEl.textContent = message;
      }

      async function uploadSelectedFile() {
        if (!uploadInput.files || uploadInput.files.length !== 1) {
          return;
        }
        const file = uploadInput.files[0];
        const form = new FormData();
        form.append('file', file);
        // PDFの更新日時を引き継ぐ（ローカルファイルのmtime）
        form.append('last_modified_ms', String(file.lastModified || ''));

        uploadButton.disabled = true;
        uploadButton.classList.add('is-busy');
        uploadButton.textContent = 'アップロード中…';
        setUploadStatus(`アップロード中…\n${file.name}`, false);

        try {
          const res = await fetch('/api/upload_pdf', { method: 'POST', body: form });
          const data = await res.json().catch(() => ({}));

          if (res.status === 201 || res.ok) {
            setUploadStatus('アップロード完了。一覧を更新しています…', false);
            window.location.reload();
            return;
          }

          if (res.status === 409) {
            setUploadStatus((data.message ? `${data.message}\n` : '') + 'ファイル名（同名）を変えて再試行してください。');
          } else {
            setUploadStatus(data.message || `アップロードに失敗しました (${res.status})`);
          }
        } catch (e) {
          setUploadStatus(`アップロードに失敗しました: ${e}`);
        } finally {
          uploadButton.disabled = false;
          uploadButton.classList.remove('is-busy');
          uploadButton.textContent = uploadButtonLabel;
          // 同じファイルを選び直しても change が発火するようにクリア
          uploadInput.value = '';
        }
      }

      uploadButton.addEventListener('click', () => {
        setUploadStatus('');
        // 同じファイルを再選択できるようにする
        uploadInput.value = '';
        uploadInput.click();
      });

      uploadInput.addEventListener('change', async () => {
        setUploadStatus('');
        if (!uploadInput.files || uploadInput.files.length !== 1) {
          return;
        }
        await uploadSelectedFile();
      });
    </script>
    <script src="{{ url_for('static', filename='js/help.js') }}"></script>
</body>
</html>
