# PDF-ParaParaTrans

PDFから段落を抽出し、ページ単位で構造を整えながら対訳辞書・機械翻訳・手修正を行い、対訳HTMLを出力するツールです。

## 注意

- ver2.0.0以前のバージョンとデータの互換性がありません。<br>申し訳ありませんが、必ず別フォルダに配置して使用してください。<br>翻訳文を旧型式からインポートするスクリプトを同梱していますが、段落構成が異なるため不完全な適用となります。ご容赦ください。
- google翻訳APIが日本語を一度英語にして再翻訳する挙動をするケースがあります。<br>この場合対訳辞書による用語統一が効きません。<br>google公式の対訳辞書を使用する手順が煩雑なため現時点では搭載を見送っています。
- google翻訳で初回(もしくは長時間APIにアクセスしなかった場合)エラーになるようです。<br>その場合は再度ページ翻訳などを実行すれば成功します。狙って再現できないため、解消は少し先になりそうです。

## おすすめの作業方法
1. PDFをdataフォルダに入れます。
2. 詳細画面から `1.パラグラフ抽出` →　`自動タグ付け`
3. 詳細画面で「PDF」「原文」「連結文」にチェックを入れて3つのペインを表示します。
4. 各ページで文の構成と順序を確認しながら、必要に応じて下記作業を行います。
   - Home/End で先頭/末尾へ移動。
   - Alt+上下矢印で選択（なければカレント）の順序を1つずつ整える。
   - Ctrl+Alt+上下矢印で選択（なければカレント）を「前の見出しの下 / 次の見出しの上」へまとめて移動する。
   - Ctrl+Alt+Home/End で、カレント段落と同じ `style + Y範囲` の段落を**文書全体**で header/footer に一括更新（確認ダイアログあり）。
    - Alt++で途中で切れている段落を結合する。
    - Alt+数値で本文(Alt+0)、見出し(Alt+1-6)、ヘッダ(Alt+7)、フッタ(Alt+8)を整える。
   - Alt+Home/End で「先頭へ移動して header / 末尾へ移動して footer」を一発で行う。
    - 特定のスタイルの見出しを一気に設定したい場合、編集パネルを開いて`同スタイルを一括更新` 。
        - header/footer/remove を選んだ場合は、`style + Y範囲` で文書全体に一括適用します（確認ダイアログあり）。
5. 一章分などきっりのよい分量のページを整えたら `2.段落連結` をクリック。
6. 表示を「PDF」「置換文」「Auto」の3ペインにします。
7. 整形した範囲の最初のページから `ページ対訳置換` → `ページ翻訳` を繰り返していきます。
8. 対訳辞書に登録した方がよい単語を見つけたら `辞書登録`
9. 整形した範囲の自動翻訳が終わったら、表示を「連結文」「Auto」「訳文」の3ペインにします。
10. 各段落で編集ボタンをクリックし、訳を整え終わったらステータスを `確定` に変更します。
11. 3から10までを全ページ終わるまで繰り返します。
12. `5.対訳HTML出力` をクリックして `data` フォルダのhtmlファイルを参照しやすい場所にコピーします。完成！

# 一覧画面
- `data` フォルダに置かれたPDFファイルの一覧を表示します。
- 詳細画面でパラグラフ抽出を行うと、`data` フォルダに `(PDF名).json` ファイルが作られます。<br>これが `PDF-ParaParaTrans` が使用する `ブックデータ` です。

## ヘルプツールチップ
このアプリケーションでは、一部のUI要素にマウスカーソルを合わせると、機能に関する説明がツールチップとして表示されます。
ツールチップの内容は、`static/parapara-help.md` ファイルから取得されています。

## ブックリストの更新
ブックリストを最新の状態に更新します。新しいPDFファイルをdataフォルダに追加した場合などにクリックしてください。

## ブックのフィルタリング
タイトルまたはファイル名でPDFリストをフィルタリングします。<br>検索語を入力してボタンをクリックしてください。

# 詳細画面

## 表題と構造を保存
現在のページの段落順序（必要に応じて結合情報など）と、タイトル欄の内容を保存します。

- `ページ翻訳` / `ページ対訳置換` / `対訳HTML出力` などの前にも自動的に保存されますが、編集後に手動で保存したい場合に使います。

## 一覧画面に戻る
一覧画面に戻ります。

## パラグラフの抽出
PDFからパラグラフを抽出します。<br>この操作はPDFのサイズによっては時間がかかる場合があります。
- PyMuPdfの「ブロック」を単位としてデータを抽出しています。<br>PDFの作成方法によっては文のつながりがおかしくなったり、表の読み順が崩れたりします。これはPDF-ParaParaTransでは対策できないのでご容赦ください。
- PDFファイルの一番上のブロックと一番下のブロックからヘッダー/フッタを統計的に求めています。<br>3回以上同位置に同文字列や数値のみブロックが現れるとblock_tagにheader/footerをセットします。

## 自動タグ付け
抽出されたパラグラフのスタイル(PDFで指定されていたfont-nameとfont-size)に基づいて、荒い判定でタグ付けを行います。

- 既に `p` 以外に設定されている `block_tag` は基本的に変更されません。

1. **シンボルフォントの判定**:
   - **ルール**: フォントがシンボルフォント（例: Wingdings, Webdings）に該当するスタイルは、`block_tag` を `p`（本文）に設定します。
   - **理由**: シンボルフォントは通常、見出しや重要なテキストではなく、装飾やアイコンとして使用されるためです。

2. **連続出現行数の判定**:
   - **ルール**: 同じスタイルが1ページに4行以上連続して出現するスタイルは、`block_tag` を `p` に設定します。
   - **理由**: 連続した行として出現するスタイルは、本文やリスト項目である可能性が高いと判断します。

3. **文字数の判定**:
   - **ルール**: 100文字以上のパラグラフを持つスタイルは、`block_tag` を `p` に設定します。
   - **理由**: 長いテキストを持つスタイルは本文である可能性が高いと判断します。

4. **章見出し(h1)**:
   - **ルール**: フォントサイズが本文フォントサイズより大きく、1ページに1回だけ出現する場合、`block_tag` を `h1` に設定します。
   - **理由**: PDF-Paraparatransでは `h1` を文書全体のタイトルではなく「章」見出しと考えています。そのため1ページに1回以上出現するスタイルはH3以下としています。

5. **ページ内に3回まで出現する見出し(h3)**:
   - **ルール**: フォントサイズが本文フォントサイズより大きく、1ページに最大3回出現するスタイルは、`block_tag` を `h3` に設定します。
   - **理由**: PDF-Paraparatransでは `h3` を「ページ内に複数出現する見出しの中で最上位」と考えています。<br>自動タグ付けでは `h1` と `h3` の間をあけて、 `h2` にするかどうかの判断ができるようにしています。 

6. **ページ内に4回以上出現する見出し(h5)**:
   - **ルール**: フォントサイズが本文フォントサイズより大きく、1ページに4回以上出現するスタイルは、`block_tag` を `h5` に設定します。
   - **理由**: 頻繁に出現するスタイルは、リストの見出しや小見出しとして使用される可能性があるためです。<br> `h4` と `h6` を空けることで、あとで階層を調整しやすいようにしています。

7. **その他**:
   - **ルール**: 上記のいずれにも該当しない場合、`block_tag` を `p` に設定します。

## シンボル置換
`src_html` を元に `src_text`（原文）を作り直し、シンボルフォント由来の文字を辞書に従って置換します。<br>
`config/symbolfont_dict.txt` を編集した後に何度でも実行できます。

- 目的: Wingdings などの「見た目は記号だがPDF内部ではa/b/c等」になっている文字を、翻訳前に記号や任意文字列へ補正するため
- 置換ルール: `フォント名.キャラクター<TAB>置換後文字列`
- 注意: `src_text` を更新するため、対訳置換や翻訳の前に実行するのがおすすめです

## すべてのページで段落の連結
全ページの段落について「連結文」「置換文」列を作り直します。

- 「置換文」列の置換はいったんリセットされます。
- この処理で「訳文」列が変更されることはありません。

## 辞書の作成
抽出・連結されたパラグラフから辞書（候補）を作成します。

## 辞書の翻訳
作成された辞書を翻訳します。（現在非表示）

## すべてのページを対訳置換
全ページの「置換文」列に対して、対訳辞書に基づく置換を行います。

- この処理は時間がかかる場合があります。

## すべてのページを翻訳
全ページを翻訳します。この操作は時間がかかる場合があります。

- 翻訳対象は主に「置換文」列です。
- 結果は「Auto」「訳文」列に反映され、ステータスが `auto` になります。

## 構造の保存
現在の構成をファイルに保存します。（現在未リリース）

## HTMLのエクスポート
対訳付きのHTMLファイルをエクスポートします。

## ブックデータのリロード
書籍データをリロードします。（現在未リリース）

## HTMLのレンダリング
画面の段落表示を再レンダリングします。（現在はボタン非表示）

## 目次パネルの表示/非表示
目次パネルの表示/非表示を切り替えます。

## PDFパネルの表示/非表示
PDFパネルの表示/非表示を切り替えます。

## 前のページ
前のページに移動します。

## 次のページ
次のページに移動します。

## ページ対訳置換
現在のページを対訳辞書で置換し、「置換文」列を更新します。

## ページの翻訳
現在のページを翻訳します。

## 同一連結文の訳揃え
同一 `結合文` を持つ段落の訳を文書全体で統一します。

- 対象: `結合文` が空でない段落（ヘッダー/フッターも含みます）
- 代表訳の決め方: `fixed > draft > auto > none` の順で最上位を採用（同一ステータスで訳が違う場合は先勝ち）
- 反映内容: 同じ `結合文` グループ内の `Auto` / `訳文` / `ステータス` を代表訳に揃えます

注意: 下位ステータス側の訳は上書きされるため、用語統一や見出しの統一をしたい場合に使ってください。

## 辞書登録
単語の対訳辞書登録ポップアップを開きます。

- クリップボードの文字列を「原語」に自動入力します。
- 既存登録があれば検索して内容を埋めます。
- 状態（大文字小文字の扱い、対象外、未翻訳など）を選んで登録できます。

## ソースHTMLの表示/非表示
ソースHTMLの表示/非表示を切り替えます。

## 原文の表示/非表示
原文の表示/非表示を切り替えます。

## 連結文の表示/非表示
連結文の表示/非表示を切り替えます。

## 置換文の表示/非表示
置換文の表示/非表示を切り替えます。

## 自動翻訳の表示/非表示
自動翻訳の表示/非表示を切り替えます。

## 訳文の表示/非表示
訳文の表示/非表示を切り替えます。

## ログを開く
ログウィンドウを開きます。

## ホットキーマッパーを開く
ホットキーマッパーウィンドウを開きます。
